#!/bin/bash
# nlpp -- test newly installed pipeline
# 20171010 Paul Huygen
export thisdir="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd)"
scriptname=${0##*/}
scriptpath=$thisdir/$scriptname
initscript="/home/huygen/projecten/pipelines/nlpp/progenv"
source $initscript
export MODROOT=${thisdir}/nlppmodules
res=0

function get_language() {
    echo "Get Language" >&2
    if
	[ -z "${NAFLANG+x}" ]
    then
	naffile=`mktemp -t naf.XXXXXX`
	cat >$naffile
	export NAFLANG=`cat $naffile | python $thisdir/langdetect.py` 
        cat $naffile | $scriptpath
	result=$?
	rm $naffile
    fi

}


function runmodule {
   local infile=$1
   local modnam=$2
   local outfile=$3
   cat ${infile} | $MODROOT/${modnam}/run > ${outfile}
   res=$?
}


# run_pipeline -- run the pipeline
# args:
# 1: directory to run the pipeline in
# 2: input naf
# 3: path to file with list of modules
function run_pipeline {
    echo "Run the pipeline."  >&2
    local modulelist=$1
    local infile=in.naf
    rundir=`mktemp -d -t nlpp.XXXXXX`
    cd $rundir
    cat >${infile}
    cat ${infile} >&2
    local lastfile=$infile
    while
	IFS=' ' read -r module || [[ -n "$module" ]] >&2
    do
	echo "Annotate ${lastfile} with ${module}"
	runmodule ${lastfile} ${module} ${module}.naf
	lastfile=${module}.naf
	if
	    [ $res -gt 0 ]
	then
	    errormodule=${module}
	    break
	fi
    done < ${modulelist}
    if
	[ $res -gt 0 ]
    then
	echo "Error occurred in " ${errormodule} >&2
    else
	cat ${lastfile}
    fi
    rm -rf $tempdir
}

if
    [ -z "${NAFLANG+x}" ]
then
    echo "No Language parameter yet." >&2
    get_language
else
    echo "Do the work." >&2
    if
	[ "${NAFLANG}" == "en" ]
    then
	run_pipeline ${thisdir}/modules.en
    elif
	[ "${NAFLANG}" == "nl" ]
    then
	run_pipeline ${thisdir}/modules.nl
    else
	echo "Cannot process docs in language " ${NAFLANG} >&2
    fi
fi
